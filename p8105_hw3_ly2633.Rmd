---
title: "p8105_hw3_ly2633"
author: "Leila Yan"
date: "2024-10-06"
output: html_document
---

Load libraries
```{r}
library(tidyverse)
library(ggplot2)
library(patchwork)
library(knitr)
```
### Problem 1
```{r}
library(p8105.datasets)
data("ny_noaa")
```

Do some data cleaning. Create separate variables for year, month, and day. Ensure observations for temperature, precipitation, and snowfall are given in reasonable units. For snowfall, what are the most commonly observed values? Why?
```{r}
ny_noaa_cleaned <- ny_noaa %>%
  janitor::clean_names()%>%
  drop_na() %>%
  mutate(
    year = year(date),
    month = month(date),
    day = day(date),
    tmax = as.numeric(tmax) / 10,  
    tmin = as.numeric(tmin) / 10,   
    prcp = as.numeric(prcp) / 10,   
    snowfall = as.numeric(snow)    
  )

common_snowfall <- ny_noaa_cleaned %>%
  count(snowfall) %>%
  arrange(desc(n))
common_snowfall
```
The most commonly observed snowfall value is 0, with over 1.1 million instances. This is expected because many days in the dataset likely had no snowfall, especially in regions or seasons where snow is uncommon. Other common values, like 25, 13, 51, and 5, likely represent typical snowfall measurements in millimeters during snow events, but they occur much less frequently compared to zero snowfall days. The predominance of zero snowfall values is because, in many locations, snow only occurs seasonally or not at all, leading to many days with no snow recorded throughout the year.


### Problem 2
Load, tidy, merge, and otherwise organize the data sets. Your final dataset should include all originally observed variables; exclude participants less than 21 years of age, and those with missing demographic data; and encode data with reasonable variable classes (i.e. not numeric, and using factors with the ordering of tables and plots in mind).
```{r}
# load, tidy, merge, organize datasets
accel_df = 
  read_csv("Data/nhanes_accel.csv") %>%
  janitor::clean_names()%>%
  drop_na()

Covar_df = 
  read_csv("Data/nhanes_covar.csv", skip=4) %>%
  janitor::clean_names() %>%
  filter(age >= 21) %>%
  mutate(education=recode(education, "1" = "Less than high school", "2" = "High school equivalent", "3" = "More than high school"), sex=recode(sex, "1"="Male", "2" = "Female")) %>%
  drop_na()

merged_data = left_join(Covar_df, accel_df, by="seqn") %>% 
  relocate("seqn","sex", "age", "bmi", "education") %>%
  mutate(across(seqn:education, as.character))

```


Produce a reader-friendly table for the number of men and women in each education category, and create a visualization of the age distributions for men and women in each education category. Comment on these items.

```{r}
# Prepare data to make the reader friendly table
education_sex_table = merged_data %>%
  mutate(education=recode(education, "1" = "Less than high school", "2" = "High school equivalent", "3" = "More than high school"), sex=recode(sex, "1"="Male", "2" = "Female")) %>%
  group_by(education, sex) %>%
  summarise(count = n(), .groups = 'drop')
```

```{r}
# Create a reader friendly table
kable(education_sex_table, col.names = c("Education", "Sex", "Count"), 
      caption = "Education and Sex Distribution")
```


```{r}
# Create a barplot
barplot = ggplot(merged_data, aes(x = sex, fill = education)) +
  geom_bar(position = "dodge") +
  labs(title = "Distribution of Men and Women Across Education Categories",
       x = "Sex", y = "Count", fill = "Education Level") +
  theme_minimal()

barplot
```

Comments:
The table shows the number of men and women across three different education categories: "Less than high school," "High school equivalent," and "More than high school." Women and men are fairly represented across all education levels, with a slightly higher count of men in the "High school equivalent" and "More than high school" categories. Specifically, men show higher numbers in the "High school equivalent" (35 vs. 23) and "More than high school" (56 vs. 59), whereas the "Less than high school" category is almost balanced (27 men vs. 28 women). The bar plot visualizes the distribution of men and women across these education levels. The plot clearly illustrates that for the "More than high school" category, both men and women have the highest counts, followed by the "High school equivalent" category, with a lower number of participants in the "Less than high school" category. The balance in the "Less than high school" group is striking, while the other two categories show more disparity between men and women.


Using your tidied dataset, aggregate across minutes to create a total activity variable for each participant. Plot these total activities (y-axis) against age (x-axis); your plot should compare men to women and have separate panels for each education level. Include a trend line or a smooth to illustrate differences. Comment on your plot.

```{r}
# Aggregate the data
aggregate_df = 
  merged_data %>%
  mutate(total_minutes= rowSums(select(., starts_with("min")))) %>%
  relocate("seqn","sex", "age", "bmi", "education", "total_minutes")

# Plot total activities against age
scatterplot_aggregate = 
  aggregate_df %>%
  mutate(age=as.integer(age)) %>%
  ggplot(., mapping=aes(x=age, y=total_minutes, color=sex)) + geom_point(na.rm=TRUE, size=1) + theme_light() +
  ggtitle("Plot for age against total activities") + xlab("age") + ylab("total minutes") +
  scale_x_continuous(expand=c(0,0), limits=c(0, 100)) +theme(plot.title = element_text(hjust=0.5)) + geom_smooth() +
  facet_grid(. ~ education)

scatterplot_aggregate 
```
Comments:
In all panels, there is noticeable variability in total activities, but the trends show distinct patterns. For participants with a high school equivalent education, both men and women exhibit a peak in total activities around age 25 to 35, followed by a decline, with women generally engaging in more activities than men. Among participants with less than a high school education, the activity levels decline more sharply after age 50, particularly for men. For participants with more than a high school education, men and women show more stable activity levels throughout middle age, though women again tend to have higher activity levels overall. The smooth trend lines indicate that educational attainment and gender interact with age to influence physical activity levels over the lifespan, with women consistently engaging in more total activities across education levels.



Accelerometer data allows the inspection activity over the course of the day. Make a three-panel plot that shows the 24-hour activity time courses for each education level and use color to indicate sex. Describe in words any patterns or conclusions you can make based on this graph; including smooth trends may help identify differences.

```{r}
# Get data ready for plotting
plot_longer = merged_data %>%
  pivot_longer(., cols= starts_with("min"), names_to = "minutes", values_to = "readings") %>%
  mutate(minutes = as.numeric(gsub("min", "", minutes)))

final_plot_df = merged_data %>%
  pivot_longer(., cols = starts_with("min"), names_to = "minutes", values_to = "readings") %>%
  mutate(minutes = as.numeric(gsub("min", "", minutes))) %>%
  group_by(minutes, sex, education) %>%
  summarise(mean=mean(readings, na.rm=TRUE))

# Plot the graph
scatterplot_24h_activity = ggplot(final_plot_df, mapping=aes(x=minutes, y=mean, color=sex)) + geom_point(size=0.25, rm.NA=TRUE) + theme_light() + facet_grid(.~ education) +
  geom_smooth(size=0.7) + scale_x_continuous(limits=c(0, 1400), breaks=seq(0, 1400, by=200)) +
  scale_y_continuous(limits=c(0,18), breaks=seq(0,18, by=3)) + xlab("24-hour activity time courses") + ylab("mean acceleorometers readings per minute") +
  ggtitle("Scatterplot of 24-hour activity against the mean acceleorometers readings per minute") + theme(legend.position = "bottom", plot.title=element_text(hjust=.5))

scatterplot_24h_activity
```
Comments:
Across all education levels, the general activity pattern follows a similar daily cycle, with low activity during early morning hours, a sharp increase around mid-morning, peak activity in the afternoon, and a gradual decline into the evening. The smooth trend lines suggest that, overall, there are no substantial differences between males and females in terms of the daily activity cycle, although women tend to exhibit slightly higher accelerometer readings during peak activity periods in the "high school equivalent" and "more than high school" groups. This trend indicates that women may engage in slightly more vigorous activities or sustain higher activity levels throughout the day. These observations highlight that daily activity patterns are relatively similar across education levels, but small gender differences exist in overall activity intensity, particularly during peak hours.


### Problem 3
Import, clean, and tidy these data, and describe the resulting dataset.

```{r}
Jan2020_df = 
  read_csv("citibike/Jan 2020 Citi.csv") %>%
  janitor::clean_names() %>%
   mutate("year" = "2020", "month" = "Jan")

Jan2024_df = 
  read_csv("citibike/Jan 2024 Citi.csv") %>%
  janitor::clean_names()%>%
   mutate("year" = "2024", "month" = "Jan")

July2020_df = 
  read_csv("citibike/July 2020 Citi.csv") %>%
  janitor::clean_names() %>%
   mutate("year" = "2020", "month" = "July")

July2024_df = 
  read_csv("citibike/July 2024 Citi.csv") %>%
  janitor::clean_names() %>%
   mutate("year" = "2024", "month" = "July")
```


Produce a reader-friendly table showing the total number of rides in each combination of year and month separating casual riders and Citi Bike members. Comment on these results.
```{r}
# Prepare the data for creating a reader-friendly table
all_data =
  bind_rows(Jan2020_df, Jan2024_df, July2020_df, July2024_df) %>%
  mutate(weekdays = factor(weekdays, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")))


ride_summary =
  all_data  %>%
  group_by(year, month, member_casual) %>%
  summarise(total_rides = n(), .groups = 'drop') %>%
  pivot_wider(names_from = member_casual, values_from = total_rides, values_fill = 0) %>%
  rename(Casual_Riders = casual, Citi_Bike_Members = member) 

ride_summary
```

```{r}
# Create a reader friendly table
kable(ride_summary, 
      col.names = c("Year", "Month", "Casual Riders", "Citi Bike Members"), 
      caption = "Ride Summary by Year and Month", 
      format = "html", 
      align = 'c') 
```


Answers:
Casual Riders: In January 2020, there were 984 rides by casual riders, which more than doubled by January 2024 (2,108 rides). A similar trend can be seen for July, with a substantial rise from 5,637 rides in July 2020 to 10,894 rides in July 2024.

Citi Bike Members: The growth in Citi Bike member rides is also notable. In January 2020, there were 11,436 rides, increasing to 16,753 rides in January 2024. The July data shows an even larger jump, from 15,411 rides in July 2020 to 36,262 rides in July 2024.



Make a table showing the 5 most popular starting stations for July 2024; include the number of rides originating from these stations.
```{r}
top_stations =
  July2024_df %>%
  group_by(start_station_name) %>%
  summarise(total_rides = n(), .groups = 'drop') %>%
  arrange(desc(total_rides)) %>%
  slice_max(total_rides, n = 5)
top_stations

# Create a reader friendly table
kable(top_stations, 
      col.names = c("Station Name", "Total Rides"), 
      caption = "Top 5 Stations with Most Rides in July 2024", 
      format = "html", 
      align = 'c')
```

Answers:
The most popular station is Pier 61 at Chelsea Piers with 163 rides, followed by University Pl & E 14 St and W 21 St & 6 Ave with 155 and 152 rides, respectively. This data suggests that these stations are key locations for bike-sharing services, likely reflecting high foot traffic and accessibility in these areas. The slight variations in ride numbers among these stations indicate that multiple points across the city are highly utilized, with no overwhelming dominance by any one station.


Make a plot to investigate the effects of day of the week, month, and year on median ride duration. This plot can include one or more panels, but should facilitate comparison across all variables of interest. Comment on your observations from this plot.
```{r}
# calculation the median ride duration
median_ride_duration_year = all_data %>%
  group_by(year) %>%
  summarize(median_duration = median(duration, na.rm=TRUE))

median_ride_duration_month = all_data %>%
  group_by(month) %>%
  summarize(median_duration = median(duration, na.rm=TRUE))

median_ride_duration_weekdays = all_data %>%
  group_by(weekdays) %>%
  summarize(median_duration = median(duration, na.rm=TRUE))

median_ride_duration_membership = all_data %>%
  group_by(member_casual) %>%
  summarize(median_duration = median(duration, na.rm=TRUE))

median_ride_duration_bike = all_data %>%
  group_by(rideable_type) %>%
  summarize(median_duration = median(duration, na.rm=TRUE))


# create the plots
plot_1 = ggplot(median_ride_duration_year, aes(x = year, y = median_duration)) +
             geom_bar(stat="identity", fill="pink", width=0.75) +
             xlab("year") + ylab("median duration") + ggtitle("median duration(year)") +
             theme_light() + theme(plot.title = element_text(hjust=0.5))

plot_2 = ggplot(median_ride_duration_month, aes(x = month, y = median_duration)) +
             geom_bar(stat="identity", fill="blue", width=0.75) +
             xlab("month") + ylab("median duration") + ggtitle("median duration(month)") + theme_light() + theme(plot.title = element_text(hjust=0.5))

plot_3 = ggplot(median_ride_duration_weekdays, aes(x = weekdays, y = median_duration)) +
             geom_bar(stat="identity", fill="purple", width=0.75) +
             xlab("weekday") + ylab("median duration") + ggtitle("median duration(weekday)") + theme_light() + theme(plot.title = element_text(hjust=0.5))

# final plot
plot_1 + plot_2 + plot_3

```
Comments:
This plot illustrates the effects of year, month, and weekday on median ride duration. Over time, the median ride duration decreased from 2020 to 2024. Comparing months, July shows a longer median duration than January, likely reflecting seasonal factors such as warmer weather or more leisure activities in summer. Across the days of the week, ride durations remain relatively consistent, though weekends (Saturday and Sunday) have slightly longer durations, which may be due to more recreational riding compared to weekdays. These patterns suggest temporal variations in ride behavior.



There were relatively few electric Citi Bikes in 2020, but many more are available now. For data in 2024, make a figure that shows the impact of month, membership status, and bike type on the distribution of ride duration. Comment on your results.
```{r}
# Membership status
membership_plot = ggplot(median_ride_duration_membership, aes(x = member_casual, y = median_duration)) +
             geom_bar(stat="identity", fill="pink", width=0.75) +
             xlab("membership type") + ylab("median duration") + ggtitle("median duration(membership type)") +
             theme_light() + theme(plot.title = element_text(hjust=0.5))
  

# Bike type
bike_plot = ggplot(median_ride_duration_bike, aes(x=rideable_type, y=median_duration)) +
             geom_bar(stat="identity", fill="green", width=0.75) +
             xlab("bike type") + ylab("median duration") + ggtitle("median duration(bike type)") +
             theme_light() + theme(plot.title = element_text(hjust=0.5))

bike_plot + membership_plot
```
Answers:
Casual riders tend to have longer ride durations compared to members, indicating that non-subscribers may use the bikes for more extended trips. When comparing bike types, electric bikes are now widely available, and both classic and electric bikes show similar median ride durations. However, electric bikes might be slightly favored for longer trips, as suggested by the higher median for casual riders using electric bikes. Seasonal variation, shown by the difference between January and July, suggests that ride durations are longer in the warmer months (July), likely due to more favorable weather conditions. This implies that casual users, particularly during summer, may engage more in recreational biking, while members might use the service for shorter, more frequent commutes.
