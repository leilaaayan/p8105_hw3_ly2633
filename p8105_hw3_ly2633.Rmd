---
title: "p8105_hw3_ly2633"
author: "Leila Yan"
date: "2024-10-06"
output: html_document
---

Load libraries
```{r}
library(tidyverse)
library(ggplot2)
library(patchwork)
```
### Problem 1
```{r}
library(p8105.datasets)
data("ny_noaa")
```





### Problem 2
Load, tidy, merge, and otherwise organize the data sets. Your final dataset should include all originally observed variables; exclude participants less than 21 years of age, and those with missing demographic data; and encode data with reasonable variable classes (i.e. not numeric, and using factors with the ordering of tables and plots in mind).
```{r}
accel_df = 
  read_csv("Data/nhanes_accel.csv") %>%
  janitor::clean_names()%>%
  drop_na()

Covar_df = 
  read_csv("Data/nhanes_covar.csv", skip=4) %>%
  janitor::clean_names() %>%
  filter(age >= 21) %>%
  mutate(education=recode(education, "1" = "Less than high school", "2" = "High school equivalent", "3" = "More than high school"), sex=recode(sex, "1"="Male", "2" = "Female")) %>%
  drop_na()

merged_data = left_join(Covar_df, accel_df, by="seqn") %>% 
  relocate("seqn","sex", "age", "bmi", "education") %>%
  mutate(across(seqn:education, as.character))

```


Produce a reader-friendly table for the number of men and women in each education category, and create a visualization of the age distributions for men and women in each education category. Comment on these items.

```{r}
education_sex_table = merged_data %>%
  mutate(education=recode(education, "1" = "Less than high school", "2" = "High school equivalent", "3" = "More than high school"), sex=recode(sex, "1"="Male", "2" = "Female")) %>%
  group_by(education, sex) %>%
  summarise(count = n(), .groups = 'drop')
```


```{r}
barplot = ggplot(merged_data, aes(x = sex, fill = education)) +
  geom_bar(position = "dodge") +
  labs(title = "Distribution of Men and Women Across Education Categories",
       x = "Sex", y = "Count", fill = "Education Level") +
  theme_minimal()

barplot
```

Comments:
The table shows the number of men and women across three different education categories: "Less than high school," "High school equivalent," and "More than high school." Women and men are fairly represented across all education levels, with a slightly higher count of men in the "High school equivalent" and "More than high school" categories. Specifically, men show higher numbers in the "High school equivalent" (35 vs. 23) and "More than high school" (56 vs. 59), whereas the "Less than high school" category is almost balanced (27 men vs. 28 women). The bar plot visualizes the distribution of men and women across these education levels. The plot clearly illustrates that for the "More than high school" category, both men and women have the highest counts, followed by the "High school equivalent" category, with a lower number of participants in the "Less than high school" category. The balance in the "Less than high school" group is striking, while the other two categories show more disparity between men and women.


Using your tidied dataset, aggregate across minutes to create a total activity variable for each participant. Plot these total activities (y-axis) against age (x-axis); your plot should compare men to women and have separate panels for each education level. Include a trend line or a smooth to illustrate differences. Comment on your plot.

```{r}
# Aggregate the data
aggregate_df = 
  merged_data %>%
  mutate(total_minutes= rowSums(select(., starts_with("min")))) %>%
  relocate("seqn","sex", "age", "bmi", "education", "total_minutes")

# Plot total activities against age
scatterplot_aggregate = 
  aggregate_df %>%
  mutate(age=as.integer(age)) %>%
  ggplot(., mapping=aes(x=age, y=total_minutes, color=sex)) + geom_point(na.rm=TRUE, size=1) + theme_light() +
  ggtitle("Plot for age against total activities") + xlab("age") + ylab("total minutes") +
  scale_x_continuous(expand=c(0,0), limits=c(0, 100)) +theme(plot.title = element_text(hjust=0.5)) + geom_smooth() +
  facet_grid(. ~ education)

scatterplot_aggregate 
```
Comments:


Accelerometer data allows the inspection activity over the course of the day. Make a three-panel plot that shows the 24-hour activity time courses for each education level and use color to indicate sex. Describe in words any patterns or conclusions you can make based on this graph; including smooth trends may help identify differences.
```{r}
# Get data ready for plotting
plot_longer = merged_data %>%
  pivot_longer(., cols= starts_with("min"), names_to = "minutes", values_to = "readings") %>%
  mutate(minutes = as.numeric(gsub("min", "", minutes)))

final_plot_df = merged_data %>%
  pivot_longer(., cols = starts_with("min"), names_to = "minutes", values_to = "readings") %>%
  mutate(minutes = as.numeric(gsub("min", "", minutes))) %>%
  group_by(minutes, sex, education) %>%
  summarise(mean=mean(readings, na.rm=TRUE))

# Plot the graph
scatterplot_24h_activity = ggplot(final_plot_df, mapping=aes(x=minutes, y=mean, color=sex)) + geom_point(size=0.25, rm.NA=TRUE) + theme_light() + facet_grid(.~ education) +
  geom_smooth(size=0.7) + scale_x_continuous(limits=c(0, 1400), breaks=seq(0, 1400, by=200)) +
  scale_y_continuous(limits=c(0,18), breaks=seq(0,18, by=3)) + xlab("24-hour activity time courses") + ylab("mean acceleorometers readings per minute") +
  ggtitle("Scatterplot of 24-hour activity against the mean acceleorometers readings per minute") + theme(legend.position = "bottom", plot.title=element_text(hjust=.5))

scatterplot_24h_activity
```
Comments:


### Problem 3
Import, clean, and tidy these data, and describe the resulting dataset.

```{r}
Jan2020_df = 
  read_csv("citibike/Jan 2020 Citi.csv") %>%
  janitor::clean_names() %>%
   mutate("year" = "2020", "month" = "Jan")

Jan2024_df = 
  read_csv("citibike/Jan 2024 Citi.csv") %>%
  janitor::clean_names()%>%
   mutate("year" = "2024", "month" = "Jan")

July2020_df = 
  read_csv("citibike/July 2020 Citi.csv") %>%
  janitor::clean_names() %>%
   mutate("year" = "2020", "month" = "July")

July2024_df = 
  read_csv("citibike/July 2024 Citi.csv") %>%
  janitor::clean_names() %>%
   mutate("year" = "2024", "month" = "July")
```


Produce a reader-friendly table showing the total number of rides in each combination of year and month separating casual riders and Citi Bike members. Comment on these results.
```{r}
all_data =
  bind_rows(Jan2020_df, Jan2024_df, July2020_df, July2024_df) %>%
  mutate(weekdays = factor(weekdays, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")))


ride_summary =
  all_data  %>%
  group_by(year, month, member_casual) %>%
  summarise(total_rides = n(), .groups = 'drop') %>%
  pivot_wider(names_from = member_casual, values_from = total_rides, values_fill = 0) %>%
  rename(Casual_Riders = casual, Citi_Bike_Members = member) 

ride_summary
```

Answers:
Casual Riders: In January 2020, there were 984 rides by casual riders, which more than doubled by January 2024 (2,108 rides). A similar trend can be seen for July, with a substantial rise from 5,637 rides in July 2020 to 10,894 rides in July 2024.

Citi Bike Members: The growth in Citi Bike member rides is also notable. In January 2020, there were 11,436 rides, increasing to 16,753 rides in January 2024. The July data shows an even larger jump, from 15,411 rides in July 2020 to 36,262 rides in July 2024.



Make a table showing the 5 most popular starting stations for July 2024; include the number of rides originating from these stations.
```{r}
top_stations =
  July2024_df %>%
  group_by(start_station_name) %>%
  summarise(total_rides = n(), .groups = 'drop') %>%
  arrange(desc(total_rides)) %>%
  slice_max(total_rides, n = 5)
top_stations
```

Answers:
The most popular station is Pier 61 at Chelsea Piers with 163 rides, followed by University Pl & E 14 St and W 21 St & 6 Ave with 155 and 152 rides, respectively. This data suggests that these stations are key locations for bike-sharing services, likely reflecting high foot traffic and accessibility in these areas. The slight variations in ride numbers among these stations indicate that multiple points across the city are highly utilized, with no overwhelming dominance by any one station.


Make a plot to investigate the effects of day of the week, month, and year on median ride duration. This plot can include one or more panels, but should facilitate comparison across all variables of interest. Comment on your observations from this plot.
```{r}
# calculation the median ride duration
median_ride_duration_year = all_data %>%
  group_by(year) %>%
  summarize(median_duration = median(duration, na.rm=TRUE))

median_ride_duration_month = all_data %>%
  group_by(month) %>%
  summarize(median_duration = median(duration, na.rm=TRUE))

median_ride_duration_weekdays = all_data %>%
  group_by(weekdays) %>%
  summarize(median_duration = median(duration, na.rm=TRUE))

median_ride_duration_membership = all_data %>%
  group_by(member_casual) %>%
  summarize(median_duration = median(duration, na.rm=TRUE))

median_ride_duration_bike = all_data %>%
  group_by(rideable_type) %>%
  summarize(median_duration = median(duration, na.rm=TRUE))


# create the plots
plot_1 = ggplot(median_ride_duration_year, aes(x = year, y = median_duration)) +
             geom_bar(stat="identity", fill="pink", width=0.75) +
             xlab("year") + ylab("median duration") + ggtitle("median duration(year)") +
             theme_light() + theme(plot.title = element_text(hjust=0.5))

plot_2 = ggplot(median_ride_duration_month, aes(x = month, y = median_duration)) +
             geom_bar(stat="identity", fill="blue", width=0.75) +
             xlab("month") + ylab("median duration") + ggtitle("median duration(month)") + theme_light() + theme(plot.title = element_text(hjust=0.5))

plot_3 = ggplot(median_ride_duration_weekdays, aes(x = weekdays, y = median_duration)) +
             geom_bar(stat="identity", fill="purple", width=0.75) +
             xlab("weekday") + ylab("median duration") + ggtitle("median duration(weekday)") + theme_light() + theme(plot.title = element_text(hjust=0.5))

# final plot
plot_1 + plot_2 + plot_3

```
Answers:




There were relatively few electric Citi Bikes in 2020, but many more are available now. For data in 2024, make a figure that shows the impact of month, membership status, and bike type on the distribution of ride duration. Comment on your results.
```{r}
data_2024 =
  all_data %>%
  filter(grepl("2024", year_month)) %>%
  mutate(
    month = case_when(
      grepl("Jan", year_month) ~ "January",
      grepl("July", year_month) ~ "July"
    )
  )

ggplot(data_2024, aes(x = month, y = duration, fill = member_casual)) +
  geom_violin(outlier.size = 1, outlier.alpha = 0.5) +
  facet_wrap(~ rideable_type) +
  theme_minimal() +
  labs(
    title = "Impact of Month, Membership Status, and Bike Type on Ride Duration (2024)",
    x = "Month",
    y = "Ride Duration (minutes)",
    fill = "Membership Status"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "bottom")
```
Answers:#### rewrite this answer!!!
The figure shows that in 2024, casual riders tend to have longer ride durations compared to Citi Bike members, regardless of bike type. Electric bikes, which have become more widely available, exhibit a greater range of ride times, especially for casual riders in July. Ride durations are generally longer in the summer (July) compared to the winter (January), likely due to better weather conditions. Overall, electric bikes are associated with longer rides, and casual riders appear to use Citi Bikes for more leisurely or recreational purposes, especially in warmer months.




